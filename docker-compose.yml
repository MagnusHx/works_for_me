services:
  # ------------------------------------------------------------
  # Download (kører typisk på CPU og kræver kun Kaggle + audio deps)
  # ------------------------------------------------------------
  audio-emotion-download:
    image: audio-emotion:cpu
    build:
      context: .
      dockerfile: dockerfiles/train.dockerfile
      args:
        UV_EXTRAS: "train,cpu"
    volumes:
      - ${HOME}/.kaggle/kaggle.json:/root/.kaggle/kaggle.json:ro
      - ./data:/app/data
    environment:
      KAGGLE_CONFIG_DIR: /root/.kaggle
    command: uv run audio-emotion download --output-dir data/raw/audio-emotions

  # ------------------------------------------------------------
  # CPU training
  # ------------------------------------------------------------
  audio-emotion-train-cpu:
    image: audio-emotion:cpu
    build:
      context: .
      dockerfile: dockerfiles/train.dockerfile
      args:
        UV_EXTRAS: "train,cpu"
    profiles: ["cpu"]
    shm_size: "8gb"
    volumes:
      - ${HOME}/.kaggle/kaggle.json:/root/.kaggle/kaggle.json:ro
      - ./data:/app/data
      - ./models:/app/models
      - ./configs:/app/configs
      - ./outputs:/app/outputs
    environment:
      KAGGLE_CONFIG_DIR: /root/.kaggle
    command: uv run audio-emotion-train

  # ------------------------------------------------------------
  # GPU training (cu117)
  # ------------------------------------------------------------
  audio-emotion-train-gpu:
    image: audio-emotion:cu117
    build:
      context: .
      dockerfile: dockerfiles/train.dockerfile
      args:
        UV_EXTRAS: "train,cu117"
    profiles: ["gpu"]
    shm_size: "8gb"
    gpus: all
    volumes:
      - ${HOME}/.kaggle/kaggle.json:/root/.kaggle/kaggle.json:ro
      - ./data:/app/data
      - ./models:/app/models
      - ./configs:/app/configs
      - ./outputs:/app/outputs
    environment:
      KAGGLE_CONFIG_DIR: /root/.kaggle
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    command: uv run audio-emotion-train

  # ------------------------------------------------------------
  # GPU profiling (cProfile)
  # ------------------------------------------------------------
  audio-emotion-train-profile-gpu:
    image: audio-emotion:cu117
    build:
      context: .
      dockerfile: dockerfiles/train.dockerfile
      args:
        UV_EXTRAS: "train,cu117"
    profiles: ["gpu", "profile"]
    shm_size: "8gb"
    gpus: all
    volumes:
      - ${HOME}/.kaggle/kaggle.json:/root/.kaggle/kaggle.json:ro
      - ./data:/app/data
      - ./models:/app/models
      - ./configs:/app/configs
      - ./outputs:/app/outputs
      - ./profiles:/app/profiles
    environment:
      KAGGLE_CONFIG_DIR: /root/.kaggle
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    command: >
      uv run python -m cProfile
      -o /app/profiles/audio_emotion_train.prof
      -c "from audio_emotion.train import app; app()"
